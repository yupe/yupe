var redactorActive=false;var $table,$table_tr,$table_td,$tbody,$thead,$current_tr,$current_td;(function(b){b.fn.redactor=function(c){var d=new a(this,c);d.init();return d};function a(d,c){this.opts=b.extend({lang:"ru",air:false,toolbar:"main",path:false,focus:true,resize:true,handler:false,autoclear:true,autoformat:true,removeClasses:true,removeStyles:false,convertLinks:true,autosave:false,interval:20,imageUpload:"/tests/upload.php",imageGetJson:false,imageUploadFunction:false,fileUpload:"/tests/file_upload.php",fileDownload:"/tests/file_download.php?file=",fileDelete:"/tests/file_delete.php?delete=",fileUploadFunction:false,css:"blank.css",visual:true,fullscreen:false,overlay:true,colors:Array("#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000")},c);this.$el=b(d)}a.prototype={_loadFile:function(c,f){var d=f[0];f.splice(0,1);if(typeof(d)=="function"){var e=d}else{var e=function(){this._loadFile(d,f)}.bind2(this)}this.dynamicallyLoad(c,e)},loadFiles:function(d){var c=d[0];d.splice(0,1);this._loadFile(c,d)},dynamicallyLoad:function(e,g){var f=document.getElementsByTagName("head")[0];var d=document.createElement("script");d.src=e;var c=false;d.onload=d.onreadystatechange=function(){if(!c&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){c=true;if(g){g()}d.onload=d.onreadystatechange=null}};f.appendChild(d);return undefined},init:function(){if(this.opts.path===false){b("script").each(function(d,e){if(e.src){if(e.src.match(/\/redactor\.min\.js.*$/)){this.opts.path=e.src.replace(/redactor\.min\.js(\?.*)?$/,"")}else{if(e.src.match(/\/redactor\.js.*$/)){this.opts.path=e.src.replace(/redactor\.js(\?.*)?$/,"")}}}}.bind2(this))}this.height=this.$el.css("height");this.width=this.$el.css("width");this.editorID=this.$el.attr("id");if(typeof(this.editorID)=="undefined"){this.editorID=this.getRandomID()}if(this.opts.air){this.opts.toolbar="air";this.air=b('<div id="imp_redactor_air_'+this.editorID+'" class="redactor_air" style="display: none;"></div>')}var c=[];c.push(this.opts.path+"langs/"+this.opts.lang+".js");if(this.opts.toolbar!==false){c.push(this.opts.path+"toolbars/"+this.opts.toolbar+".js")}c.push(function(){this.start()}.bind2(this));this.loadFiles(c);this.build();this.enable(this.$el.val())},start:function(){this.buildToolbar();this.buildResizer();this.enableAir();b(this.doc).bind("paste",function(c){setTimeout(function(){var d=b('<span id="pastemarkerend">&nbsp;</span>');this.insertNodeAtCaret(d.get(0));this.clean()}.bind2(this),200)}.bind2(this));b(this.doc).keypress(function(g){var d=g.keyCode||g.which;if(navigator.userAgent.indexOf("AppleWebKit")!=-1){if(g.shiftKey&&d==13){if(g.preventDefault){g.preventDefault()}var c=b("<span><br /></span>");this.insertNodeAtCaret(c.get(0));this.setFocusNode(c.get(0));return false}}if(d==13&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey){if(this.getParentNodeName()=="BODY"){if(g.preventDefault){g.preventDefault()}var f=b("<p><br /></p>");this.insertNodeAtCaret(f.get(0));return false}else{return true}}}.bind2(this));b(this.doc).keyup(function(f){var c=f.keyCode||f.which;if(c==8||c==46){if(b(this.doc.body).html()==""){if(f.preventDefault){f.preventDefault()}var d=b("<p><br /></p>").get(0);b(this.doc.body).append(d);this.setFocusNode(d);return false}}if(c==13&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){if(this.getParentNodeName()=="BODY"){if(f.preventDefault){f.preventDefault()}element=b(this.getCurrentNode());if(element.get(0).tagName!="P"){newElement=b("<p>").append(element.clone().get(0).childNodes);element.replaceWith(newElement);newElement.html("<br />");this.setFocusNode(newElement.get(0));return false}if(this.opts.convertLinks){b(this.doc).linkify()}}else{return true}}}.bind2(this));this.shortcuts();this.autoSave();if(this.opts.focus){this.focus()}},shortcuts:function(){b(this.doc).keydown(function(d){var c=d.keyCode||d.which;if(d.ctrlKey){if(c==90){if(d.preventDefault){d.preventDefault()}this.execCommand("undo",null)}else{if(c==90&&d.shiftKey){if(d.preventDefault){d.preventDefault()}this.execCommand("redo",null)}else{if(c==77){if(d.preventDefault){d.preventDefault()}this.execCommand("removeFormat",null)}else{if(c==66){if(d.preventDefault){d.preventDefault()}this.execCommand("bold",null)}else{if(c==73){if(d.preventDefault){d.preventDefault()}this.execCommand("italic",null)}else{if(c==74){if(d.preventDefault){d.preventDefault()}this.execCommand("insertunorderedlist",null)}else{if(c==75){if(d.preventDefault){d.preventDefault()}this.execCommand("insertorderedlist",null)}else{if(c==76){if(d.preventDefault){d.preventDefault()}this.execCommand("superscript",null)}}}}}}}}}if(!d.shiftKey&&c==9){if(d.preventDefault){d.preventDefault()}this.execCommand("indent",null)}else{if(d.shiftKey&&c==9){if(d.preventDefault){d.preventDefault()}this.execCommand("outdent",null)}}}.bind2(this))},focus:function(){if(b.browser.msie){this.$frame.get(0).contentWindow.focus()}else{this.$frame.focus()}},build:function(){this.$box=b('<div id="redactor_box_'+this.editorID+'" class="redactor_box"></div>');this.$frame=b('<iframe frameborder="0" scrolling="auto" id="redactor_frame_'+this.editorID+'" style="height: '+this.height+';" class="redactor_frame"></iframe>');this.$el.hide();this.$box.insertAfter(this.$el).append(this.$frame).append(this.$el);this.formSubmit()},enable:function(c){this.doc=this.getDoc(this.$frame);if(typeof(c)=="undefined"||c==""){if(this.opts.autoformat===true){if(b.browser.msie){c="<p></p>"}else{c="<p><br /></p>"}}}this.write(this.setDoc(c));this.designMode()},enableAir:function(){if(this.opts.air===false){return false}b("#imp_redactor_air_"+this.editorID).hide();b(this.doc).bind("textselect",this.editorID,function(f){var c=b("#imp_redactor_air_"+this.editorID).width();var g=this.$frame.width();var d=g-f.clientX;if(d<c){f.clientX=f.clientX-c}b("#imp_redactor_air_"+this.editorID).css({left:f.clientX+"px",top:(f.clientY+8)+"px"}).show()}.bind2(this));b(this.doc).bind("textunselect",this.editorID,function(){b("#imp_redactor_air_"+this.editorID).hide()}.bind2(this))},write:function(c){if(this.doc!=null){this.doc.open();this.doc.write(c);this.doc.close()}},setDoc:function(d){var c='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n';c+='<html><head><link media="all" type="text/css" href="'+this.opts.path+"css/"+this.opts.css+'" rel="stylesheet"></head>';c+="<body>";c+=d;c+="</body></html>";return c},getDoc:function(c){c=c.get(0);if(c.contentDocument){return c.contentDocument}else{if(c.contentWindow&&c.contentWindow.document){return c.contentWindow.document}else{if(c.document){return c.document}else{return null}}}},designMode:function(){if(this.doc){this.doc.designMode="on";this.$frame.load(function(){if(b.browser.mozilla){this.enableObjects()}this.doc.designMode="on";this.docObserve()}.bind2(this))}},enableObjects:function(){if(b.browser.mozilla){this.doc.execCommand("enableObjectResizing",false,"false");this.doc.execCommand("enableInlineTableEditing",false,"false")}},docObserve:function(){b(this.doc.body).find("img").click(function(c){this.imageEdit(c)}.bind2(this));b(this.doc.body).find("table").click(function(c){this.tableObserver(c)}.bind2(this));b(this.doc.body).find(".redactor_file_link").click(function(c){this.fileEdit(c)}.bind2(this))},formSubmit:function(){if(this.opts.visual===false){return false}var c=this.$box.parents("form");if(c.size()==0){return false}c.submit(function(){this.clean(false);this.syncCodeToTextarea();return true}.bind2(this));return true},execCommand:function(c,f){if(this.opts.visual&&this.doc){try{this.focus();if(c=="inserthtml"&&b.browser.msie){this.doc.selection.createRange().pasteHTML(f)}else{if(c=="formatblock"&&b.browser.msie){this.doc.execCommand(c,false,"<"+f+">")}else{if(c=="indent"&&b.browser.mozilla){this.doc.execCommand("formatblock",false,"blockquote")}else{this.doc.execCommand(c,false,f)}}}}catch(d){}this.syncCodeToTextarea();if(this.opts.air){b("#imp_redactor_air_"+this.frameID).hide()}}},clean:function(c){var d=this.getCodeEditor();if(c!==false){d=d.replace(/<span id="pastemarkerend">&nbsp;<\/span>/,"#marker#")}d=this.formating(d);d=d.replace(/(<\!\-\-([\w\W]*?)\-\->)/ig,"");d=this._clean(d);d=d.replace(/<div(.*?)>/gi,"<p$1>");d=d.replace(/<\/div>/,"</p>");d=d.replace(/ lang="([\w\W]*?)"/gi,"");if(this.opts.removeClasses){d=d.replace(/ class="([\w\W]*?)"/gi,"")}else{d=this._cleanClasses(d)}if(this.opts.removeStyles){d=d.replace(/ style="([\w\W]*?)"/gi,"")}else{d=this._cleanStyles(d)}d=d.replace(/<a name="(.*?)">([\w\W]*?)<\/a>/gi,"");d=d.replace(/\&nbsp;\&nbsp;\&nbsp;/gi," ");d=d.replace(/\&nbsp;\&nbsp;/gi," ");d=d.replace(/\s*style="\s*"/gi,"");d=d.replace(/\<span>&nbsp;<\/span>/gi,"");d=d.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");d=this._clean(d);d=this.formating(d);if(c!==false){d=d.replace(/#marker#/,'<span id="pastemarkerend">&nbsp;</span>')}this.setCodeEditor(d);if(c!==false){var e=b(this.doc.body).find("#pastemarkerend").get(0);this.setFocusNode(e)}},_cleanClasses:function(c){c=c.replace(/\s*class="TOC(.*?)"/gi,"");c=c.replace(/\s*class="Heading(.*?)"/gi,"");c=c.replace(/\s*class="Body(.*?)"/gi,"");c=c.replace(/<p(.*?)>&nbsp;<\/p>/gi,"");return c},_cleanStyles:function(c){c=c.replace(/\s*mso-[^:]+:[^;"]+;?/gi,"");c=c.replace(/\s*margin(.*?)pt\s*;/gi,"");c=c.replace(/\s*margin(.*?)cm\s*;/gi,"");c=c.replace(/\s*text-indent:(.*?)\s*;/gi,"");c=c.replace(/\s*line-height:(.*?)\s*;/gi,"");c=c.replace(/\s*page-break-before: [^\s;]+;?"/gi,'"');c=c.replace(/\s*font-variant: [^\s;]+;?"/gi,'"');c=c.replace(/\s*tab-stops:[^;"]*;?/gi,"");c=c.replace(/\s*tab-stops:[^"]*/gi,"");c=c.replace(/\s*face="[^"]*"/gi,"");c=c.replace(/\s*face=[^ >]*/gi,"");c=c.replace(/\s*font:(.*?);/gi,"");c=c.replace(/\s*font-size:(.*?);/gi,"");c=c.replace(/\s*font-weight:(.*?);/gi,"");c=c.replace(/\s*font-family:[^;"]*;?/gi,"");c=c.replace(/<span style="Times New Roman&quot;">\s\n<\/span>/gi,"");return c},_clean:function(c){return c.replace(/<(?!\s*\/?(span|label|a|br|p|b|i|del|strike|img|video|audio|iframe|object|embed|param|blockquote|mark|cite|small|ul|ol|li|hr|dl|dt|dd|sup|sub|big|pre|code|figure|figcaption|strong|em|table|tr|td|th|tbody|thead|tfoot|h1|h2|h3|h4|h5|h6)\b)[^>]+>/gi,"")},formating:function(e){if(b.browser.msie){e=e.replace(/< *(\/ *)?(\w+)/g,function(h){return h.toLowerCase()});e=e.replace(/style="(.*?)"/g,function(h){return h.toLowerCase()});e=e.replace(/ jQuery(.*?)=\"(.*?)\"/gi,"")}if(b.browser.mozilla){e=this.convertSpan(e)}e=e.replace(/\<font([\w\W]*?)color="(.*?)">([\w\W]*?)\<\/font\>/gi,'<span style="color: $2;">$3</span>');e=e.replace(/\<font([\w\W]*?)>([\w\W]*?)\<\/font\>/gi,"<span$1>$2</span>");e=e.replace(/\<p><span>([\w\W]*?)<\/span><\/p>/gi,"<p>$1</p>");e=e.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");e=e.replace(/ class="Apple-style-span"/gi,"");e=e.replace(/ class="Apple-tab-span"/gi,"");e=e.replace(/<p><p>/g,"<p>");e=e.replace(/<\/p><\/p>/g,"</p>");e=e.replace(/<hr(.*?)>/g,"<hr>");e=e.replace(/<p>&nbsp;/g,"<p>");e=e.replace(/<p><ul>/g,"<ul>");e=e.replace(/<p><ol>/g,"<ol>");e=e.replace(/<\/ul><\/p>/g,"</ul>");e=e.replace(/<\/ol><\/p>/g,"</ol>");e=e.replace(/[\t]*/g,"");e=e.replace(/\n\s*\n/g,"\n");e=e.replace(/^[\s\n]*/,"");e=e.replace(/[\s\n]*$/,"");var g=["<pre></pre>","<blockquote></blockquote>","<em></em>","<b></b>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span><span>","<span>&nbsp;<span>","<p> </p>","<p></p>","<p>&nbsp;</p>","<p><br></p>","<div></div>"];for(i=0;i<g.length;++i){var c=g[i];e=e.replace(new RegExp(c,"gi"),"")}var f="\r\n";var g=["<form","<fieldset","<legend","<object","<embed","<select","<option","<input","<textarea","<br>","<br />","<pre","<blockquote","<ul","<ol","<li","<dl","<dt","<dd","<!--","<table","<thead","<tbody","<caption","</caption>","<th","<tr","<td","<figure"];for(i=0;i<g.length;++i){var c=g[i];e=e.replace(new RegExp(c,"gi"),f+c)}var d=["</p>","</div>","</ul>","</ol>","</h1>","</h2>","</h3>","</h4>","</h5>","</h6>","</dl>","</dt>","</dd>","</form>","</blockquote>","</pre>","</legend>","</fieldset>","</object>","</embed>","</textarea>","</select>","</option>","</table>","</thead>","</tbody>","</tr>","</td>","</th>","</figure>"];for(i=0;i<d.length;++i){var c=d[i];e=e.replace(new RegExp(c,"gi"),c+f)}e=e.replace(/<li/g,"\t<li");e=e.replace(/<tr/g,"\t<tr");e=e.replace(/<td/g,"\t\t<td");e=e.replace(/<\/tr>/g,"\t</tr>");return e},convertSpan:function(c){c=c.replace(/\<span(.*?)style="font-weight: bold;"\>([\w\W]*?)\<\/span\>/gi,"<strong>$2</strong>");c=c.replace(/\<span(.*?)style="font-style: italic;"\>([\w\W]*?)\<\/span\>/gi,"<em>$2</em>");c=c.replace(/\<span(.*?)style="font-weight: bold; font-style: italic;"\>([\w\W]*?)\<\/span\>/gi,"<em><strong>$2</strong></em>");c=c.replace(/\<span(.*?)style="font-style: italic; font-weight: bold;"\>([\w\W]*?)\<\/span\>/gi,"<strong><em>$2</em></strong>");return c},buildToolbar:function(){if(this.opts.toolbar===false){return false}this.$toolbar=b("<ul>").addClass("redactor_toolbar");if(this.opts.air){b(this.air).append(this.$toolbar);this.$box.prepend(this.air)}else{this.$box.prepend(this.$toolbar)}b.each(RTOOLBAR,function(k,n){var l=b("<li>");if(k=="fullscreen"){b(l).addClass("redactor_toolbar_right")}var h=b('<a href="javascript:void(null);" title="'+n.title+'" class="redactor_btn_'+k+'"><span>&nbsp;</span></a>');if(typeof(n.func)=="undefined"){h.click(function(){this.execCommand(n.exec,k)}.bind2(this))}else{if(n.func!="show"){h.click(function(o){this[n.func](o)}.bind2(this))}}if(k=="backcolor"||k=="fontcolor"||typeof(n.dropdown)!="undefined"){var m=b('<div class="redactor_dropdown" style="display: none;">');if(k=="backcolor"||k=="fontcolor"){if(k=="backcolor"){if(b.browser.msie){var e="BackColor"}else{var e="hilitecolor"}}else{var e="ForeColor"}b(m).width(210);var f=this.opts.colors.length;for(var d=0;d<f;++d){var c=this.opts.colors[d];var j=b('<a rel="'+c+'" href="javascript:void(null);" class="redactor_color_link"></a>').css({backgroundColor:c});b(m).append(j);var g=this;b(j).click(function(){var o=b(this).attr("rel");g.execCommand(e,o)})}}else{b.each(n.dropdown,function(o,q){if(typeof(q.style)=="undefined"){q.style=""}if(q.name=="separator"){var p=b('<a class="redactor_separator_drop">')}else{var p=b('<a href="javascript:void(null);" style="'+q.style+'">'+q.title+"</a>");if(typeof(q.func)=="undefined"){b(p).click(function(){this.execCommand(q.exec,o)}.bind2(this))}else{b(p).click(function(r){this[q.func](r)}.bind2(this))}}b(m).append(p)}.bind2(this))}this.$box.append(m)}if(k=="backcolor"||k=="fontcolor"||typeof(n.dropdown)!="undefined"){this.hdlHideDropDown=function(o){this.hideDropDown(o,m,k)}.bind2(this);this.hdlShowDropDown=function(o){this.showDropDown(o,m,k)}.bind2(this);h.click(this.hdlShowDropDown);b(document).click(this.hdlHideDropDown)}b(l).append(h);this.$toolbar.append(l);if(typeof(n.separator)!="undefined"){var l=b('<li class="redactor_separator"></li>');this.$toolbar.append(l)}}.bind2(this));b(this.doc).click(function(){this.hideAllDropDown()}.bind2(this))},showDropDown:function(h,j,d){this.hideAllDropDown();this.setBtnActive(d);this.getBtn(d).addClass("dropact");var g=this.getBtn(d).position().left;if(this.opts.air){var c=this.air.position().left;var f=this.air.position().top;g+=c;b(j).css("top",f+28)}b(j).css("left",g+"px").show()},hideAllDropDown:function(){this.$toolbar.find("a.dropact").removeClass("act").removeClass("dropact");this.$box.find(".redactor_dropdown").hide()},hideDropDown:function(d,f,c){if(!b(d.target).parent().hasClass("dropact")){b(f).removeClass("act");this.showedDropDown=false;this.hideAllDropDown()}b(document).unbind("click",this.hdlHideDropDown);b(this.doc).unbind("click",this.hdlHideDropDown)},fullscreen:function(){if(this.opts.fullscreen===false){this.changeBtnIcon("fullscreen","normalscreen");this.setBtnActive("fullscreen");this.opts.fullscreen=true;this.height=this.$frame.css("height");this.width=(this.$box.width()-2)+"px";var c=this.getCodeEditor();this.$box.addClass("redactor_box_fullscreen").after('<span id="fullscreen_'+this.editorID+'"></span>');b(document.body).prepend(this.$box).css("overflow","hidden");this.enable(c);this.enableAir();b(this.doc).click(function(){this.hideAllDropDown()}.bind2(this));this.fullScreenResize();b(window).resize(function(){this.fullScreenResize()}.bind2(this));b(document).scrollTop(0,0);this.focus()}else{this.removeBtnIcon("fullscreen","normalscreen");this.setBtnInactive("fullscreen");this.opts.fullscreen=false;b(window).unbind("resize",function(){this.fullScreenResize()}.bind2(this));b(document.body).css("overflow","");var c=this.getCodeEditor();this.$box.removeClass("redactor_box_fullscreen").css("width","auto");b("#fullscreen_"+this.editorID).after(this.$box).remove();this.enable(c);this.enableAir();b(this.doc).click(function(){this.hideAllDropDown()}.bind2(this));this.$frame.css("height",this.height);this.$el.css("height",this.height);this.focus()}},fullScreenResize:function(){if(this.opts.fullscreen===false){return}var d=42;if(this.opts.air){d=2}var c=b(window).height()-d;this.$box.width(b(window).width()-2);this.$frame.height(c);this.$el.height(c)},getSelection:function(){if(this.$frame.get(0).contentWindow.getSelection){return this.$frame.get(0).contentWindow.getSelection()}else{if(this.$frame.get(0).contentWindow.document.selection){return this.$frame.get(0).contentWindow.document.selection.createRange()}}},replaceSelection:function(d){var f,c,e;if(typeof this.$frame.get(0).contentWindow.getSelection!="undefined"){f=window.getSelection();if(f.getRangeAt&&f.rangeCount){c=this.$frame.get(0).contentWindow.getSelection().getRangeAt(0);c.deleteContents();if(c.createContextualFragment){e=c.createContextualFragment(d)}else{var h=this.$frame.get(0).contentWindow.document.createElement("div"),g;h.innerHTML=d;e=this.$frame.get(0).contentWindow.document.createDocumentFragment();while((g=h.firstChild)){e.appendChild(g)}}c.insertNode(e)}}else{if(this.$frame.get(0).contentWindow.document.selection&&this.$frame.get(0).contentWindow.document.selection.type!="Control"){c=this.$frame.get(0).contentWindow.document.selection.createRange();c.pasteHTML(d)}}},saveSelection:function(){if(window.getSelection){sel=this.getSelection();if(sel.getRangeAt&&sel.rangeCount){this.cursorPosition=sel.getRangeAt(0)}}else{if(document.selection&&document.selection.createRange){this.cursorPosition=this.getSelection()}}this.cursorPosition=null},restoreSelection:function(){if(this.cursorPosition){if(window.getSelection){sel=this.getSelection();sel.removeAllRanges();sel.addRange(this.cursorPosition)}else{if(document.selection&&this.cursorPosition.select){this.cursorPosition.select()}}}},insertNodeAtCaret:function(g){if(typeof window.getSelection!="undefined"){var h=this.getSelection();if(h.rangeCount){var d=h.getRangeAt(0);d.collapse(false);d.insertNode(g);d=d.cloneRange();d.selectNodeContents(g);d.collapse(false);h.removeAllRanges();h.addRange(d)}}else{if(typeof document.selection!="undefined"&&document.selection.type!="Control"){var e=(g.nodeType==1)?g.outerHTML:g.data;var j="marker_"+(""+Math.random()).slice(2);e+='<span id="'+j+'"></span>';var f=this.getSelection();f.collapse(false);f.pasteHTML(e);var c=document.getElementById(j);f.moveToElementText(c);f.select();c.parentNode.removeChild(c)}}},getParentNodeName:function(){if(window.getSelection){return this.getSelection().getRangeAt(0).startContainer.parentNode.nodeName}else{if(document.selection){return this.getSelection().parentElement().nodeName}}},getParentNode:function(){if(window.getSelection){return this.getSelection().getRangeAt(0).startContainer.parentNode}else{if(document.selection){return this.getSelection().parentElement()}}},getParentNodeID:function(){if(window.getSelection){return this.getSelection().getRangeAt(0).startContainer.parentNode.id}else{if(document.selection){return this.getSelection().parentElement().id}}},getCurrentNode:function(){if(window.getSelection){return this.getSelection().getRangeAt(0).startContainer}else{if(document.selection){return this.getSelection()}}},setFocusNode:function(f,d){var c=this.doc.createRange();var e=this.getSelection();var d=d?0:1;if(e!=null){c.selectNodeContents(f);e.addRange(c);e.collapse(f,d)}this.focus()},showTable:function(){redactorActive=this;this.modalInit(RLANG.table,this.opts.path+"plugins/table.html",360,200)},insertTable:function(){var h=b("#redactor_table_rows").val();var e=b("#redactor_table_columns").val();var k=b("<div></div>");var d=Math.floor(Math.random()*99999);var g=b('<table id="table'+d+'"><tbody></tbody></table>');for(i=0;i<h;i++){var j=b("<tr></tr>");for(z=0;z<e;z++){var f=b("<td>&nbsp;</td>");b(j).append(f)}b(g).append(j)}b(k).append(g);var c=b(k).html();if(b.browser.msie){c+="<p></p>"}else{c+="<p>&nbsp;</p>"}redactorActive.execCommand("inserthtml",c);this.enableObjects();this.docObserve();this.modalClose();$table=b(this.doc).find("body").find("#table"+d)},tableObserver:function(c){$table=b(c.target).parents("table");$table_tr=$table.find("tr");$table_td=$table.find("td");$table_td.removeClass("current");$tbody=b(c.target).parents("tbody");$thead=b($table).find("thead");$current_td=b(c.target);$current_td.addClass("current");$current_tr=b(c.target).parents("tr")},deleteTable:function(){b($table).remove();$table=false},deleteRow:function(){b($current_tr).remove()},deleteColumn:function(){var c=b($current_td).get(0).cellIndex;b($table).find("tr").each(function(){b(this).find("td").eq(c).remove()})},addHead:function(){if(b($table).find("thead").size()!=0){this.deleteHead()}else{var c=b($table).find("tr").first().clone();c.find("td").html("&nbsp;");$thead=b("<thead></thead>");$thead.append(c);b($table).prepend($thead)}},deleteHead:function(){b($thead).remove();$thead=false},insertRowAbove:function(){this.insertRow("before")},insertRowBelow:function(){this.insertRow("after")},insertColumnLeft:function(){this.insertColumn("before")},insertColumnRight:function(){this.insertColumn("after")},insertRow:function(c){var d=b($current_tr).clone();d.find("td").html("&nbsp;");if(c=="after"){b($current_tr).after(d)}else{b($current_tr).before(d)}},insertColumn:function(d){var c=0;$current_td.addClass("current");$current_tr.find("td").each(function(e,f){if(b(f).hasClass("current")){c=e}});$table_tr.each(function(e,f){var g=b(f).find("td").eq(c);var h=g.clone();h.html("&nbsp;");if(d=="after"){b(g).after(h)}else{b(g).before(h)}})},showFile:function(){if(jQuery.browser.msie){this.spanid=Math.floor(Math.random()*99999);this.execCommand("inserthtml",'<span id="span'+this.spanid+'"></span>')}redactorActive=this;var c=function(){var d="";if(this.opts.fileUploadFunction){d=this.opts.fileUploadFunction()}b("#redactor_file").dragupload({url:this.opts.fileUpload+d,success:function(e){this.fileUploadCallback(e)}.bind2(this)});this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload+d,success:function(e){this.fileUploadCallback(e)}.bind2(this)})}.bind2(this);redactorActive=this;this.modalInit(RLANG.file,this.opts.path+"plugins/file.html?r",500,380,c)},fileUploadCallback:function(c){if(b.browser.msie){b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).after(c);b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).remove()}else{redactorActive.execCommand("inserthtml",c)}this.modalClose();this.docObserve()},fileEdit:function(g){var d=g.target;var f=b(d).attr("rel");var c=function(){b("#file").val(b(d).text());b("#redactorFileDeleteBtn").click(function(){this.fileDelete(d,f)}.bind2(this));b("#redactorFileDownloadBtn").click(function(){this.fileDownload(d,f)}.bind2(this))}.bind2(this);redactorActive=this;this.modalInit(RLANG.file,this.opts.path+"plugins/file_edit.html",400,200,c)},fileDelete:function(c,d){b(c).remove();b.get(this.opts.fileDelete+d);redactorActive.$frame.get(0).contentWindow.focus();this.modalClose()},fileDownload:function(c,d){top.location.href=this.opts.fileDownload+d},imageEdit:function(d){var c=function(){var e=b(d.target);b("#redactor_file_alt").val(e.attr("alt"));b("#redactor_image_edit_src").attr("href",e.attr("src"));b("#redactor_form_image_align").val(e.css("float"));b("#redactor_image_edit_delete").click(function(){this.deleteImage(d.target)}.bind2(this));b("#redactorSaveBtn").click(function(){this.imageSave(d.target)}.bind2(this))}.bind2(this);redactorActive=this;this.modalInit(RLANG.image,this.opts.path+"plugins/image_edit.html",380,290,c)},imageSave:function(c){b(c).attr("alt",b("#redactor_file_alt").val());var d=b("#redactor_form_image_align").val();if(d=="left"){b(c).css({"float":"left",margin:"0 10px 10px 0"})}else{if(d=="right"){b(c).css({"float":"right",margin:"0 0 10px 10px"})}else{b(c).css({"float":"none",margin:"0"})}}this.modalClose()},deleteImage:function(c){b(c).remove();this.modalClose()},showImage:function(){this.spanid=Math.floor(Math.random()*99999);if(jQuery.browser.msie){this.execCommand("inserthtml",'<span id="span'+this.spanid+'"></span>')}var c=function(){if(this.opts.imageGetJson!==false){b.getJSON(this.opts.imageGetJson,function(e){b.each(e,function(g,h){var f=b('<img src="'+h.thumb+'" rel="'+h.image+'">');f.click(function(){redactorActive.imageSetThumb(b(this).attr("rel"))});b("#redactor_image_box").append(f)})})}else{b("#redactor_tabs li").eq(1).remove()}var d="";if(this.opts.imageUploadFunction){d=this.opts.imageUploadFunction()}b("#redactor_file").dragupload({url:this.opts.imageUpload+d,success:function(e){this.imageUploadCallback(e)}.bind2(this)});this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload+d,success:function(e){this.imageUploadCallback(e)}.bind2(this)});b("#redactorUploadBtn").click(this.imageUploadCallbackLink)}.bind2(this);redactorActive=this;this.modalInit(RLANG.image,this.opts.path+"plugins/image.html",570,410,c)},imageSetThumb:function(c){this._imageSet('<img alt="" src="'+c+'" />')},imageUploadCallbackLink:function(){if(b("#redactor_file_link").val()!=""){var c='<img src="'+b("#redactor_file_link").val()+'">';redactorActive._imageSet(c)}else{this.modalClose()}},imageUploadCallback:function(c){redactorActive._imageSet(c)},_imageSet:function(c){c="<p>"+c+"</p>";redactorActive.$frame.get(0).contentWindow.focus();if(b.browser.msie){b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).after(c);b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).remove()}else{redactorActive.execCommand("inserthtml",c)}this.modalClose();this.docObserve()},showLink:function(){redactorActive=this;var c=function(){var e=this.getSelection();if(b.browser.msie){if(this.getParentNodeName()=="A"){this.insert_link_node=b(this.getParentNode());var f=this.insert_link_node.text();var d=this.insert_link_node.attr("href")}else{var f=e.text;var d="";this.spanid=Math.floor(Math.random()*99999);if(e.text!=""){this.replaceSelection('<span id="span'+this.spanid+'">'+e.text+"</span>")}else{this.execCommand("inserthtml",'<span id="span'+this.spanid+'"></span>')}}}else{if(e.anchorNode.parentNode.tagName=="A"){var d=e.anchorNode.parentNode.href;var f=e.anchorNode.parentNode.text;if(e.toString()==""){this.insert_link_node=e.anchorNode.parentNode}}else{var f=e.toString();var d=""}}b("#redactor_link_url").val(d).focus();b("#redactor_link_text").val(f)}.bind2(this);this.modalInit(RLANG.link,this.opts.path+"plugins/link.html",400,260,c)},insertLink:function(){var e=b("#redactor_link_text").val();if(e==""){return false}if(b("#redactor_link_id_url").get(0).checked){var d=""}else{var d="mailto:"}var c='<a href="'+d+b("#redactor_link_url").val()+'">'+b.trim(e)+"</a> ";if(c){if(redactorActive.insert_link_node){b(redactorActive.insert_link_node).text(e);b(redactorActive.insert_link_node).attr("href",b("#redactor_link_url").val())}else{if(b.browser.msie){b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).replaceWith(c)}else{redactorActive.execCommand("inserthtml",c)}}}redactorActive.modalClose()},showVideo:function(){if(jQuery.browser.msie){this.spanid=Math.floor(Math.random()*99999);this.execCommand("inserthtml",'<span id="span'+this.spanid+'"></span>')}redactorActive=this;this.modalInit(RLANG.video,this.opts.path+"plugins/video.html",600,360,function(){b("#redactor_insert_video_area").focus()})},insertVideo:function(){var c=b("#redactor_insert_video_area").val();if(redactorActive.opts.visual){if(c.search("iframe")){}else{c='<p class="redactor_video_box">'+c+"</p>"}}if(b.browser.msie){b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).after(c);b(redactorActive.doc.getElementById("span"+redactorActive.spanid)).remove()}else{redactorActive.execCommand("inserthtml",c)}this.modalClose()},toggle:function(){if(this.opts.visual){this.$frame.hide();var c=this.getCodeEditor();c=this.formating(c);this.$el.val(c).show();this.setBtnActive("html");this.opts.visual=false}else{this.$el.hide();this.setCodeEditor(this._clean(this.getCodeTextarea(false)));this.$frame.show();if(b(this.doc.body).html()==""){this.setCodeEditor("<p><br /></p>")}this.focus();this.setBtnInactive("html");this.opts.visual=true}},buildResizer:function(){if(this.opts.resize===false){return false}this.$resizer_box=b("<div>").addClass("redactor_resizer");this.$resizer=b("<div>");this.$resizer_box.append(this.$resizer);this.$box.append(this.$resizer_box);this.$resizer.mousedown(function(c){this.initResize(c)}.bind2(this))},initResize:function(c){if(c.preventDefault){c.preventDefault()}this.splitter=c.target;if(this.opts.visual){this.element_resize=this.$frame;this.element_resize.get(0).style.visibility="hidden";this.element_resize_parent=this.$el}else{this.element_resize=this.$el;this.element_resize_parent=this.$frame}this.stopResizeHdl=function(d){this.stopResize(d)}.bind2(this);this.startResizeHdl=function(d){this.startResize(d)}.bind2(this);this.resizeHdl=function(d){this.resize(d)}.bind2(this);b(document).mousedown(this.startResizeHdl);b(document).mouseup(this.stopResizeHdl);b(this.splitter).mouseup(this.stopResizeHdl);this.null_point=false;this.h_new=false;this.h=this.element_resize.height()},startResize:function(){b(document).mousemove(this.resizeHdl)},resize:function(d){if(d.preventDefault){d.preventDefault()}var f=d.pageY;if(this.null_point==false){this.null_point=f}if(this.h_new==false){this.h_new=this.element_resize.height()}var c=(this.h_new+f-this.null_point)-10;if(c<=30){return true}if(c>=0){this.element_resize.get(0).style.height=c+"px";this.element_resize_parent.get(0).style.height=c+"px"}},stopResize:function(c){b(document).unbind("mousemove",this.resizeHdl);b(document).unbind("mousedown",this.startResizeHdl);b(document).unbind("mouseup",this.stopResizeHdl);b(this.splitter).unbind("mouseup",this.stopResizeHdl);this.element_resize.get(0).style.visibility="visible"},getBtn:function(c){return b(this.$toolbar.find("a.redactor_btn_"+c))},setBtnActive:function(c){this.getBtn(c).addClass("act")},setBtnInactive:function(c){this.getBtn(c).removeClass("act")},changeBtnIcon:function(c,d){this.getBtn(c).addClass("redactor_btn_"+d)},removeBtnIcon:function(c,d){this.getBtn(c).removeClass("redactor_btn_"+d)},setCodeEditor:function(c){b(this.doc.body).html(c);this.docObserve()},setCodeTextarea:function(c){this.$el.val(c)},getCodeEditor:function(){return b(this.doc.body).html()},getCodeTextarea:function(c){if(c!==false){this.clean(false);this.syncCodeToTextarea()}return b.trim(this.$el.val())},syncCodeToTextarea:function(){if(this.opts.visual){this.setCodeTextarea(this.getCodeEditor())}},syncCodeToEditor:function(){this.setCodeEditor(this.getCodeTextarea(false))},handler:function(){var c=this.getCodeEditor();b.ajax({url:this.opts.handler,type:"post",data:"redactor="+escape(encodeURIComponent(c)),success:function(d){this.setCodeEditor(d);this.syncCodeToTextarea()}.bind2(this)})},destroy:function(){var c=this.getCodeEditor();this.$box.after(this.$el);this.$box.remove();this.$el.val(c).show()},autoSave:function(){if(this.opts.autosave===false){return false}setInterval(function(){b.post(this.opts.autosave,{data:this.getCodeEditor()})}.bind2(this),this.opts.interval*1000)},modalInit:function(h,e,g,d,f,c){if(b("#redactor_modal_overlay").size()==0){this.overlay=b('<div id="redactor_modal_overlay" style="display: none;"></div>');b("body").prepend(this.overlay)}if(this.opts.overlay){b("#redactor_modal_overlay").show();b("#redactor_modal_overlay").click(function(){this.modalClose()}.bind2(this))}if(b("#redactor_modal").size()==0){this.modal=b('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><div id="redactor_modal_header"></div><div id="redactor_modal_inner"></div></div>');b("body").append(this.modal)}b("#redactor_modal_close").click(function(){this.modalClose()}.bind2(this));b(document).keyup(function(j){if(j.keyCode==27){this.modalClose()}}.bind2(this));b(this.doc).keyup(function(j){if(j.keyCode==27){this.modalClose()}}.bind2(this));b.ajax({dataType:"html",type:"get",url:e,success:function(j){b.each(RLANG,function(k,m){var l=new RegExp("%RLANG."+k+"%","gi");j=j.replace(l,m)});b("#redactor_modal_inner").html(j);b("#redactor_modal_header").html(h);if(d===false){theight="auto"}else{theight=d+"px"}b("#redactor_modal").css({width:g+"px",height:theight,marginTop:"-"+d/2+"px",marginLeft:"-"+g/2+"px"}).fadeIn("fast");if(c===true){b("#imp_redactor_table_box").height(d-b("#redactor_modal_header").outerHeight()-130).css("overflow","auto")}if(typeof(f)=="function"){f()}}.bind2(this)})},modalClose:function(){b("#redactor_modal_close").unbind("click",function(){this.modalClose()}.bind2(this));b("#redactor_modal").fadeOut("fast",function(){b("#redactor_modal_inner").html("");if(this.opts.overlay){b("#redactor_modal_overlay").hide();b("#redactor_modal_overlay").unbind("click",function(){this.modalClose()}.bind2(this))}b(document).unbind("keyup",function(c){if(c.keyCode==27){this.modalClose()}}.bind2(this));b(this.doc).unbind("keyup",function(c){if(c.keyCode==27){this.modalClose()}}.bind2(this))}.bind2(this))},uploadInit:function(d,c){this.uploadOptions={url:false,success:false,start:false,trigger:false,auto:false,input:false};b.extend(this.uploadOptions,c);if(b("#"+d).get(0).tagName=="INPUT"){this.uploadOptions.input=b("#"+d);this.element=b(b("#"+d).get(0).form)}else{this.element=b("#"+d)}this.element_action=this.element.attr("action");if(this.uploadOptions.auto){b(this.uploadOptions.input).change(function(){this.element.submit(function(f){return false});this.uploadSubmit()}.bind2(this))}else{if(this.uploadOptions.trigger){b("#"+this.uploadOptions.trigger).click(function(){this.uploadSubmit()}.bind2(this))}}},uploadSubmit:function(){this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var e=document.createElement("div");var c='<iframe style="display:none" src="about:blank" id="'+this.id+'" name="'+this.id+'"></iframe>';e.innerHTML=c;document.body.appendChild(e);if(this.uploadOptions.start){this.uploadOptions.start()}b("#"+this.id).load(function(){this.uploadLoaded()}.bind2(this));return this.id},uploadForm:function(g,e){if(this.uploadOptions.input){var h="redactorUploadForm"+this.id;var c="redactorUploadFile"+this.id;this.form=b('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+e+'" name="'+h+'" id="'+h+'" enctype="multipart/form-data"></form>');var d=this.uploadOptions.input;var j=b(d).clone();b(d).attr("id",c);b(d).before(j);b(d).appendTo(this.form);b(this.form).css("position","absolute");b(this.form).css("top","-2000px");b(this.form).css("left","-2000px");b(this.form).appendTo("body");this.form.submit()}else{g.attr("target",e);g.attr("method","POST");g.attr("enctype","multipart/form-data");g.attr("action",this.uploadOptions.url);this.element.submit()}},uploadLoaded:function(){var c=b("#"+this.id);if(c.contentDocument){var e=c.contentDocument}else{if(c.contentWindow){var e=c.contentWindow.document}else{var e=window.frames[this.id].document}}if(e.location.href=="about:blank"){return true}if(this.uploadOptions.success){this.uploadOptions.success(e.body.innerHTML)}this.element.attr("action",this.element_action);this.element.attr("target","")},getRandomID:function(){return Math.floor(Math.random()*99999)}};Function.prototype.bind2=function(d){var e=this;var c=b.makeArray(arguments).slice(1);return function(g){if(g==new Object){e=null;c=null}else{if(e==null){throw"Attempt to invoke destructed method reference."}else{var f=b.makeArray(arguments);return e.apply(d,c.concat(f))}}}}})(jQuery);(function(b){var d=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,a=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,c=function(){var g=this.childNodes,f=g.length;while(f--){var h=g[f];if(h.nodeType==3){var e=h.nodeValue;if(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(d,'$1<a href="http://$2">$2</a>$3').replace(a,'$1<a href="$2">$2</a>$5');b(h).after(e).remove()}}else{if(h.nodeType==1&&!/^(a|button|textarea)$/i.test(h.tagName)){c.call(h)}}}};b.fn.linkify=function(){this.each(c)}})(jQuery);function showRedactorTabs(b,a){$("#redactor_tabs a").removeClass("redactor_tabs_act");$(b).addClass("redactor_tabs_act");$(".redactor_tabs").hide();$("#redactor_tabs"+a).show()}(function(b){b.fn.dragupload=function(c){return this.each(function(){var d=new a(this,c);d.init()})};function a(d,c){this.opts=b.extend({url:false,success:false,preview:false,text:RLANG.drop_file_here,atext:RLANG.or_choose},c);this.$el=b(d)}a.prototype={init:function(){if(!b.browser.opera&&!b.browser.msie){this.droparea=b('<div class="redactor_droparea"></div>');this.dropareabox=b('<div class="redactor_dropareabox">'+this.opts.text+"</div>");this.dropalternative=b('<div class="redactor_dropalternative">'+this.opts.atext+"</div>");this.droparea.append(this.dropareabox);this.$el.before(this.droparea);this.$el.before(this.dropalternative);this.dropareabox.bind("dragover",function(){return this.ondrag()}.bind2(this));this.dropareabox.bind("dragleave",function(){return this.ondragleave()}.bind2(this));this.dropareabox.get(0).ondrop=function(e){e.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");var d=e.dataTransfer.files[0];var c=new FormData();c.append("file",d);b.ajax({dataType:"html",url:this.opts.url,data:c,cache:false,contentType:false,processData:false,type:"POST",success:function(f){if(this.opts.success!==false){this.opts.success(f)}if(this.opts.preview===true){this.dropareabox.html(f)}}.bind2(this)})}.bind2(this)}},ondrag:function(){this.dropareabox.addClass("hover");return false},ondragleave:function(){this.dropareabox.removeClass("hover");return false}}})(jQuery);(function(a){a.event.special.textselect={setup:function(c,b){a(this).data("textselected",false);a(this).data("ttt",c);a(this).bind("mouseup",a.event.special.textselect.handler)},teardown:function(b){a(this).unbind("mouseup",a.event.special.textselect.handler)},handler:function(b){var c=a(this).data("ttt");var d=a.event.special.textselect.getSelectedText(c).toString();if(d!=""){a(this).data("textselected",true);b.type="textselect";b.text=d;a.event.handle.apply(this,arguments)}},getSelectedText:function(b){var d="";var c=a("#redactor_frame_"+b).get(0);if(c.contentWindow.getSelection){d=c.contentWindow.getSelection()}else{if(c.contentWindow.document.getSelection){d=c.contentWindow.document.getSelection()}else{if(c.contentWindow.document.selection){d=c.contentWindow.document.selection.createRange().text}}}return d}};a.event.special.textunselect={setup:function(c,b){a(this).data("rttt",c);a(this).data("textselected",false);a(this).bind("mouseup",a.event.special.textunselect.handler);a(this).bind("keyup",a.event.special.textunselect.handlerKey)},teardown:function(b){a(this).unbind("mouseup",a.event.special.textunselect.handler)},handler:function(b){if(a(this).data("textselected")){var c=a(this).data("rttt");var d=a.event.special.textselect.getSelectedText(c).toString();if(d==""){a(this).data("textselected",false);b.type="textunselect";a.event.handle.apply(this,arguments)}}},handlerKey:function(b){if(a(this).data("textselected")){var c=a(this).data("rttt");var d=a.event.special.textselect.getSelectedText(c).toString();if((b.keyCode=27)&&(d=="")){a(this).data("textselected",false);b.type="textunselect";a.event.handle.apply(this,arguments)}}}}})(jQuery);